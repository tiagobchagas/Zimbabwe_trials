---
title: "Selection of superior soybean genotypes across locations and years in Zimbabwe according to multitrait ideotype"
author: 
- Chagas, J.T.B
- Ara√∫jo, M.S.
- Pinheiro, J.B.
format:
  revealjs:
    theme: simple
    width: 1600
    height: 900
    incremental: true
    highlight-style: arrow
    transition: fade
    code-tools:
      source: true
      toggle: true
      caption: none
    code-overflow: wrap
    footer: "DGM Lab"
    logo: "../misc/esalq_hor.png"
    embed-resources: true
    slide-number: c/t
    title-slide-attributes:
      data-background-image: "../misc/dgm.jpeg"
      data-background-opacity: "1"
      data-background-size: "50%"
      data-background-position: "bottom"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

## Introduction

::: {.callout-warning .justify icon="true" title="Question"}
How to select superior soybean genotypes across locations and years (GxE interaction) according to Multitrait ideotype? (Simultaneous selection)

:::

. . .

::: {.callout-tip .justify icon="true" title="Hypothesis"}
Estimate probability of superior performance [@Dias2022] across locations and years and
classify genotypes using Bayesian Probabilistic Selection Index [@Chagas2025]

:::

## Goal
::: {.callout-important .justify icon="true" title=""}
Select superior soybean genotypes to grain yield, plant height and plant lodging using Bayesian probabilistic selection index (BPSI) [@Chagas2025]

:::



## Material and Methods
::::: {layout="[ 70, 30 ]"}
![Ensaios experimentais](../Plots/soybean_zimbabwe.png){fig-align=left width=2500 heigth=2500}

::: {#sec-column}
- 14 locations
- 6 years
- 41 trials
- 98 genotypes
- 3 traits (Grain Yield, Plant Height, Plant Lodging)
- Randomized complete block design (RCB)
- Using package ProbBreed [@Chaves2024]
:::
:::::

## Material and Methods

Individual analyses

$$
 \mathbf{y} = \mathbf{X_1b} + \mathbf{Z_1g} + \mathbf{\epsilon} 
$$

where $\mathbf{y}$ is the vector of phenotypic observations, $\mathbf{b}$  is the vector of fixed effects of replication, $\mathbf{g}$ is the vector of random effects of genotypes and $\mathbf{\epsilon}$ is the vector of random errors. $\mathbf{X_1}$, $\mathbf{X_2}$ e $\mathbf{Z_1}$ are incidence matrix of $\mathbf{b}$ and $\mathbf{g}$ effects respectively..

## Material and Methods

### Heritability 

$$
h^2 = \sigma^2g    / \sigma^2g + \sigma^2e
$$

where $\sigma^2g$ is the genetic variance and $\sigma_e^2$ is the residual variance.

### Experimental Coeficient of Variation

$$
CV = \frac{\sigma_e}{\mu} \times 100
$$

where $\mu$ is the trait mean.

## Material e M√©todos
### Likelihood ratio test

$$LRT= ‚àí2 \times (Logùêø - Log L_ùëÖ)$$

 
where $L$ is the maximum point of residual likelihood function of the complete model and $L_R$ is the same for the reduced model, that is, without the effect to be tested. The LRT value was compared with a tabulated value based on the chi-square table, with one degree of freedom and 0.95 probability.

## Material and Methods
### Bayesian model
$$
y_{jkhp} = \mu + t_h + l_k + b_{p(k)} + g_j + gl_{jk} + gt_{jh} + \varepsilon_{jkhp}
$$
where the $y_{jkhp}$  is the phenotypic record of the $j^{th}$ genotype, allocated in the $p^{th}$ block, in the $k^{th}$ location and in the year $t_{th}$. All other effects were previously defined but $b_{p(k)}$, which is the effect of the $p^{th}$ block in the $k{th}$ location, and $gl^{jk}$ , which correspond to the genotype-by-location interaction $t_h$ and $t_{jh}$  are the main effect of years and the genotypes-by-years interaction effect, respectively.

## Material and Methods

### Probability of superior performance

BPSI index uses the probability of superior performance to estimate the chance of a genotype being selected in multienvironmental trials [@Dias2022].

	
$$ 
Pr\left({\hat{g}}_i \in \Omega \middle| y\right) = \frac{1}{s}\sum_{s=1}^{s} I \left({\hat{g}}_i^{(s)} \in \Omega \middle| y\right) 
$$


where $\hat{g}_i$ is the genotypic value, $\Omega$ is a subset of genotypes with superior performance and $s$ represents each sample of posterior distribution.

## Material and methods

### Bayesian Probabilistic Selection Index
::: {.fragment data-fragment-index=1}
$$ BPSI_i = \sum_{m=1}^{t} \frac{RankProbSup^t}{\omega^t} $$

	
where $t$ is the total number of traits evaluated $(m =1, 2,‚Ä¶,t)$ and $\omega$ is a weight. Traits of greater interest will have larger $\omega$. We used weight 2 for GY and weight 1 for PH and PL. The 10% best-ranked families were selected according to the BPSI.
:::


::: {.fragment data-fragment-index=2}
| Genotype | T1(Rank) | T2(Rank) | T3(Rank) | PSI       |
|----------|----------|----------|----------|-----------|
| 1        | 10       | 5        | 2        | ‚àë i.= 17  |
| 2        | 5        | 3        | 10       | ‚àë i.= 18  |
| 3        | 7        | 3        | 10       | ‚àë i.= 19  |

:::


## Results

```{r, include=FALSE}
library(tidyverse) 
data <- read.csv("../data/Zimbabwe.csv",header = T,sep = ";")

pheno<- data[, c(4, 7, 16,21,25,27,38,41,46,63,64,65,66,68)] 


pheno$geno <- gsub(" ", "_",pheno$Crop_Variety)
pheno$geno <- factor(pheno$geno)
levels(pheno$geno) <- paste("G", 1:length(levels(pheno$geno)), sep = "_")


pheno[which(pheno$HARV_DATE==""),"LOCATION_NAME"]

pheno$DTH <- as.Date(as.character(pheno$HARV_DATE), format="%m/%d/%Y")-
                  as.Date(as.character(pheno$PLANT_DATE), format="%m/%d/%Y")-5

pheno$GRAIN_YLD_13PCT <-  gsub(",", ".", pheno$GRAIN_YLD_13PCT)
trial <-  gsub("_.*", "", pheno$LOCATION_NAME)
pheno$trial <- paste0(trial,"_", pheno$CROP_SEASON)


pheno <- pheno |> rename("Plant Height"=8, "Grain Yield"=9, "Plant lodging"=7, "rep"=4)

traits <- c(colnames(pheno)[c(7,8,9)])

pheno[, traits] <- lapply(pheno[, traits], as.numeric)

factors <- c(colnames(pheno)[c(1,2,3,4,5,6,14,15,16,17)])



traits <- c(colnames(pheno)[c(7,8,9)])


pheno[, factors] <- lapply(pheno[, factors], as.factor)

pheno$LOCATION_NAME <- substr(pheno$LOCATION_NAME, 1, 7)   
pheno$CROP_SEASON <- substr(pheno$CROP_SEASON, 3, 4)   
pheno_long <- reshape2::melt(pheno, measure.vars = traits, variable.name = "trait") #transformando o pheno em formato longo

```


```{r}
datavis1=ggplot(pheno_long, aes(x = trait, y = value, color = trait)) + geom_boxplot(outlier.shape = NA)+    geom_point(alpha = 0.2, position = "jitter", size = 1) + facet_grid(trait~LOCATION_NAME,
    scales = "free_y") + theme_bw() + theme(axis.text.x = element_text(angle=90));datavis1


```

## Results
```{r}
library(ggh4x)
library(ggpmisc)
data_vis=ggplot(data = pheno_long, aes(x=trait, y= value, color=trait)) +
  geom_boxplot() +
  geom_point( position = "jitter", alpha = 0.5) +  facet_nested(trait~LOCATION_NAME+CROP_SEASON, scales = "free_y") +
  theme_bw()+theme(axis.text.x = element_text(angle=90));data_vis
```

## Results
```{r}
stmt=readRDS("../Saves/stmt.rds")

stvc=lapply(stmt, function(x)as.data.frame(cbind(x$summary)))

#stvc.df=lapply(stmti, function(x)as.data.frame(cbind(x$vc)))



#stmt[[1]][["Blues"]][[1]][,-c(3,4)]


stvc=do.call(rbind,stvc)
stvc$trait=rownames(stvc)
stvc$env=sub("\\..*","",stvc$trait)
stvc$trait = sub(".*\\.","",stvc$trait)
stvc$geno_sig=sub("^\\S+\\s+","",stvc$geno)
stvc$geno=sub("\\s.*","",stvc$geno)
stvc$geno= as.numeric(stvc$geno)
stvc$H2=as.numeric(stvc$H2)
stvc$error=as.numeric(stvc$error)
stvc$CV=as.numeric(stvc$CV)
library(tidyverse)

stvcl= stvc |> select(geno, error, trait, env, geno_sig) |> pivot_longer(geno:error) 

stvcl$year=gsub(".*_", "", stvcl$env)  
stvcl$env=gsub("_.*", "", stvcl$env)  
stvcl$year <- substr(stvcl$year,3,4)


# cols.label=c("A20NAC", "A20NAS", "B20NAS", "A21ABI" ,"B21ABI","A21NAC", "B21NAC", "A21NAS", "B21NAS")
# names(cols.label)=c(unique(stvc$env)) 

stvcl|>  ggplot(aes(x=name,y=value))+ geom_col(data= subset(stvcl, !grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(fill="*"), color="black", fill="#a8ddb5") + geom_col(data= subset(stvcl,  grepl("error",stvcl$name)),color="black",fill="lightblue") + facet_nested(trait~env+year,scales = "free_y") + geom_text(data=subset(stvcl, !grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(label = geno_sig), size=6 ) + theme(legend.position = "top",axis.text.x = element_text(angle=90)  )  + geom_col(data= subset(stvcl, grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(fill="ns"), fill="gray", color="black")  + theme(legend.position = "top",axis.text.x = element_text(angle=90) ) + labs(x="Effects", y="Genotypic variance component") +   geom_text(data=subset(stvcl, grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(label = "ns", vjust = -1.0), size=3 )
```

## Results

```{r}
stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")
```




## Results

```{r}
stvc$CV[stvc$CV == 948.7212] <- NA
stvc$CV[stvc$CV == 130.8657] <- NA
stvc$CV[stvc$CV == 129.7948] <- NA

 stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")


```

## Results

```{r}
stvc$CV[stvc$CV == 99.4859] <- NA

 stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")


```

## Results
![Variances](../Plots/varcomp.png){}

## Results
![Variances](../Plots/varcomp1.png){}

## Results
![Density](../Plots/plots_density.png){}


## Results
![Within](../Plots/plots_perfo_within.png){}

## Results
![Across](../Plots/plots_perfo.png){}

## Results
![Density](../Plots/plots_pair.png){}

# BPSI
```{r}
#| output-location: column
#| label: bpsi-selected
#| echo: true
load("../Saves/res_PL_year.rda")
load("../Saves/res_PH_year.rda")
load("../Saves/res_GY_year.rda")

source("../data/bpsi_fun.R")

models= vector("list",length(3))


models[[1]] = res_GY;
models[[2]] = res_PH
models[[3]] = res_PL
models[[3]]$across$perfo <- models[[3]]$across$perfo[-which(models[[3]]$across$perfo$ID=="G_55"),]
names(models) <- c("GY","PH","PL")
BPSI_soy=BPSI(modlist = models,increase =c(TRUE,FALSE,FALSE),omega = c(2,1,1),int = 0.1,save.df = T,verbose = T )

df=BPSI_soy$BPSI

gen.sel = df[which(df$sel=="selected"),"gen"]


real.names=distinct(pheno[,c(5,15)])

df <- left_join(df, real.names, by = c("gen" = "geno"))

print(df)

```

## Results

Highlighting the ranking of probability of superior performance per trait of the selected families.

```{r bpsi plot ranks}
#| label: fig-ranks
#| fig-cap: "Ranking of probability of superior performance per trait"
library(knitr)

plot(BPSI_soy,category = "Ranks")
```

## Results
```{r bpsi plot}
#| label: fig-bpsi
#| fig-cap: "Selected families based on BPSI rank"
plot(BPSI_soy,category = "BPSI")
```




## Title?

- Selection of superior soybean genotypes across locations and years in Zimbabwe according to multitrait ideotype
- Multitrait selection of soybean varieties using Bayesian probabilistic selection index
-   josetchagas\@usp.br
-   Obrigado!

## Refer√™ncias
