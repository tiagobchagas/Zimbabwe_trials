---
title: "Sele√ß√£o multicaracter√≠stica de cultivares de soja utilizando m√©todo probabil√≠stico bayesiano "
author: 
- Chagas, J.T.B
- Pinheiro, J.B.
format:
  revealjs:
    theme: simple
    width: 1600
    height: 900
    incremental: true
    highlight-style: arrow
    code-tools:
      source: true
      toggle: false
      caption: none
    code-overflow: wrap
    footer: "DGM Lab"
    logo: "../misc/esalq_hor.png"
    embed-resources: true
    slide-number: c/t
    title-slide-attributes:
      data-background-image: "../misc/dgm.jpeg"
      data-background-opacity: "1"
      data-background-size: "50%"
      data-background-position: "bottom"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

## Introdu√ß√£o

- Import√¢ncia da cultura da soja 
- Melhoramento de soja na √Åfrica
- Desafio de adapta√ß√£o √†s condi√ß√µes ambientais do Zimb√°bue 



## Objetivo
::: {.callout-important .justify icon="false"}
Selecionar cultivares superiores para produtividade de gr√£os, altura de planta e acamamento utilizando o √≠ndice de sele√ß√£o probabil√≠stico Bayesiano (BPSI) [@Chagas2025]

:::

## Material e M√©todos
::::: {layout="[ 70, 30 ]"}
![Ensaios experimentais](../Plots/soybean_zimbabwe.png){fig-align=left width=2500 heigth=2500}

::: {#sec-column}
- 14 locais
- 6 anos
- 41 ensaios
- 98 gen√≥tipos
- 3 caracter√≠sticas (GY,PH,Lodging)
- Delineamento em blocos casualizados (DBC)
:::
:::::

## Material e M√©todos

An√°lise individual 

$$
 \mathbf{y} = \mathbf{X_1b} + \mathbf{Z_1g} + \mathbf{\epsilon} 
$$

onde $\mathbf{y}$ √© o vetor das observa√ß√µes fenot√≠picas, $\mathbf{b}$ √© o vetor dos efeitos fixos de repeti√ß√£o, $\mathbf{g}$ √© o vetor dos efeitos aleat√≥rios de gen√≥tipo e $\mathbf{\epsilon}$ √© o vetor dos efeitos residuais. $\mathbf{X_1}$, $\mathbf{X_2}$ e $\mathbf{Z_1}$ s√£o matrizes de incid√™ncia dos  efeitos $\mathbf{b}$ e $\mathbf{g}$ respectivamente.

## Material e M√©todos

### Herdabilidade 

$$
h^2 = \sigma^2g    / \sigma^2g + \sigma^2e
$$

onde $\sigma^2g$ √© a vari√¢ncia gen√©tica e $\sigma_e^2$ √© a vari√¢ncia do erro.

### Coeficiente de Varia√ß√£o Experimental

$$
CV = \frac{\sigma_e}{\mu} \times 100
$$

onde $\mu$ √© a m√©dia da caracter√≠stica.

## Material e M√©todos
### Teste de raz√£o de verossimilhan√ßa

$$LRT= ‚àí2 \times (Logùêø - Log L_ùëÖ)$$

onde $L$ √© o ponto m√°ximo da fun√ß√£o de verossimilhan√ßa restrita do modelo completo e $L_R$ √© o mesmo para o modelo reduzido, ou seja, sem o efeito a ser testado. O valor de LRT foi comparado com o valor tabulado com base na tabela qui-quadrado, a um grau de liberdade e probabilidade de 0,95.


## Resultados

```{r, include=FALSE}
library(tidyverse) 
data <- read.csv("../data/Zimbabwe.csv",header = T,sep = ";")

pheno<- data[, c(4, 7, 16,21,25,27,38,41,46,63,64,65,66,68)] 


pheno$geno <- gsub(" ", "_",pheno$Crop_Variety)


pheno[which(pheno$HARV_DATE==""),"LOCATION_NAME"]

pheno$DTH <- as.Date(as.character(pheno$HARV_DATE), format="%m/%d/%Y")-
                  as.Date(as.character(pheno$PLANT_DATE), format="%m/%d/%Y")-5

pheno$GRAIN_YLD_13PCT <-  gsub(",", ".", pheno$GRAIN_YLD_13PCT)
trial <-  gsub("_.*", "", pheno$LOCATION_NAME)
pheno$trial <- paste0(trial,"_", pheno$CROP_SEASON)


pheno <- pheno |> rename("Plant Height"=8, "Grain Yield"=9, "Plant lodging"=7, "rep"=4)

traits <- c(colnames(pheno)[c(7,8,9)])

pheno[, traits] <- lapply(pheno[, traits], as.numeric)

factors <- c(colnames(pheno)[c(1,2,3,4,5,6,14,15,16,17)])



traits <- c(colnames(pheno)[c(7,8,9)])


pheno[, factors] <- lapply(pheno[, factors], as.factor)

pheno$LOCATION_NAME <- substr(pheno$LOCATION_NAME, 1, 7)   
pheno$CROP_SEASON <- substr(pheno$CROP_SEASON, 3, 4)   
pheno_long <- reshape2::melt(pheno, measure.vars = traits, variable.name = "trait") #transformando o pheno em formato longo
```


```{r}
datavis1=ggplot(pheno_long, aes(x = trait, y = value, color = trait)) + geom_boxplot(outlier.shape = NA)+    geom_point(alpha = 0.2, position = "jitter", size = 1) + facet_grid(trait~LOCATION_NAME,
    scales = "free_y") + theme_bw() + theme(axis.text.x = element_text(angle=90));datavis1


```

## Resultados
```{r}
library(ggh4x)
library(ggpmisc)
data_vis=ggplot(data = pheno_long, aes(x=trait, y= value, color=trait)) +
  geom_boxplot() +
  geom_point( position = "jitter", alpha = 0.5) +  facet_nested(trait~LOCATION_NAME+CROP_SEASON, scales = "free_y") +
  theme_bw()+theme(axis.text.x = element_text(angle=90));data_vis
```

## Resultados
```{r}
stmt=readRDS("../Saves/stmt.rds")

stvc=lapply(stmt, function(x)as.data.frame(cbind(x$summary)))

#stvc.df=lapply(stmti, function(x)as.data.frame(cbind(x$vc)))



#stmt[[1]][["Blues"]][[1]][,-c(3,4)]


stvc=do.call(rbind,stvc)
stvc$trait=rownames(stvc)
stvc$env=sub("\\..*","",stvc$trait)
stvc$trait = sub(".*\\.","",stvc$trait)
stvc$geno_sig=sub("^\\S+\\s+","",stvc$geno)
stvc$geno=sub("\\s.*","",stvc$geno)
stvc$geno= as.numeric(stvc$geno)
stvc$H2=as.numeric(stvc$H2)
stvc$error=as.numeric(stvc$error)
stvc$CV=as.numeric(stvc$CV)
library(tidyverse)

stvcl= stvc |> select(geno, error, trait, env, geno_sig) |> pivot_longer(geno:error) 

stvcl$year=gsub(".*_", "", stvcl$env)  
stvcl$env=gsub("_.*", "", stvcl$env)  
stvcl$year <- substr(stvcl$year,3,4)


# cols.label=c("A20NAC", "A20NAS", "B20NAS", "A21ABI" ,"B21ABI","A21NAC", "B21NAC", "A21NAS", "B21NAS")
# names(cols.label)=c(unique(stvc$env)) 

stvcl|>  ggplot(aes(x=name,y=value))+ geom_col(data= subset(stvcl, !grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(fill="*"), color="black", fill="#a8ddb5") + geom_col(data= subset(stvcl,  grepl("error",stvcl$name)),color="black",fill="lightblue") + facet_nested(trait~env+year,scales = "free_y") + geom_text(data=subset(stvcl, !grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(label = geno_sig), size=6 ) + theme(legend.position = "top",axis.text.x = element_text(angle=90)  )  + geom_col(data= subset(stvcl, grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(fill="ns"), fill="gray", color="black")  + theme(legend.position = "top",axis.text.x = element_text(angle=90) ) + labs(x="Effects", y="Genotypic variance component") +   geom_text(data=subset(stvcl, grepl("ns", stvcl$geno_sig) & grepl("geno",stvcl$name)),aes(label = "ns", vjust = -1.0), size=3 )
```

## Resultados

```{r}
stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")
```




## Resultados

```{r}
stvc$CV[stvc$CV == 948.7212] <- NA
stvc$CV[stvc$CV == 130.8657] <- NA
stvc$CV[stvc$CV == 129.7948] <- NA

 stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")


```

## Resultados

```{r}
stvc$CV[stvc$CV == 99.4859] <- NA

 stvc |>  select(H2, CV, trait, env, geno_sig) |> pivot_longer(H2:CV) |>  
  ggplot(aes(x=env,y=value))+geom_col(aes(fill = trait), position = position_dodge())+ facet_grid(name~trait, scales = "free_y") + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + labs(x= "Environments", y="Parameters")


```

## Perguntas?

-   josetchagas\@usp.br
-   Obrigado!

## Refer√™ncias
